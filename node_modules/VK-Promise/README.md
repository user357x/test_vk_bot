# VK-Promise

Модуль для работы с ВКонтакте API и Callback API ВКонтакте.

## Установка

`npm install VK-Promise`

## Tl;dr
```js
// запрос
vk(/*string*/ метод, /*object*/ данные)
    .then(/*function*/ on_response)
    .catch(/*function*/ on_error);
// Загрузка файла
vk.upload(
    /*string*/ метод_получения_сервера,
    /*string*/ метод_сохранения_файла,
    {
        get: {/* данные передаваемые методу получения сервера*/},
        save: {/* данные передаваемые методу сохранения файла*/},
        files: {/* файлы */
            file1: /*string*/ путь_к_файлу,
            file2: stream /* необходимо указать stream.filename */,
            file3: {filename: имя_файла, buffer: Buffer},
        }
    }
);
// Получение всего что у чего есть offset
vk.getAll(/*string*/ метод_получения_данных, /*object*/ данные, /*function*/ отслеживание_прогресса)
// Функции
vk.init_longpoll(); // Запуск получения сообщения через LongPoll
vk.init_execute_cart(); // Запуск пакетной обработки запросов через execute
vk.init_callback_api(); // Получения обработчика для http.createServer
// Разное
VK.getAttachmentUrl(/*object*/ attachment); // Получения url из msg.attachments
VK.Array2Object(/*Array*/ array); // [{key:key,value:value}] => {key:value}
```

## Элементарный запрос
```js
var vk = require("VK-Promise")("Ваш access_token");

vk.users.get({
    user_id: 1 // данные передаваемые API
}).then(function (res) {
    console.log("response",res);
}).catch(function (error) {
    console.log("Ошибка",error);
});
```

## Элементарный бот
```js
var VK = require("VK-Promise"),
    vk = new VK("ваш access_token");

vk.init_longpoll(); // Запускаем получение сообщений через LongPoll

vk.on("message",function (event, msg) { // Обрабатываем сообщения
    if(msg.body == "ping") // Если текст сообщения равен ping
        msg.send("pong"); // Отвечаем pong
});
```

## Обработка need_captcha
```js
var vk = require("VK-Promise")("Ваш access_token");
// Добавляем обработчик
vk.on("captcha",function(event, data){
	console.log("Ссылка на код:", data.captcha_img);
    data.submit("Вводим код с картинки");
});
// API метод вызова captcha
vk("captcha.force",{}).then(function (res) {
     console.log("response",res);
})
```

## Элементарный бот для группы через Callback API с оптимизацией ответа на сообщения через execute
```js
var VK = require("VK-Promise"),
    http = require("http"),
    vk = VK("ваш access_token группы");

// Запускаем http сервер на 80 порту с обработкой Callback API
// PS: Сервер в настройках группы нужно вешать вручную  
var callback = vk.init_callback_api("Строка, которую должен вернуть сервер");
http.createServer(function (req, res) {
    if(req.url == "/vk_callback_api") // фильтруем по url
        return callback(req, res);
    // Далее делаем все что нам нужно
    res.end("Error 404");
}).listen(80);

// Включаем оптимизацию через execute
// Собирает все запросы и выполняет пачками раз в 334мс
// 334мс - 3 раза в секунду, стандартное ограничение  
vk.init_execute_cart();

// message_new & message_reply объединяет в message
vk.on("message",function (event, msg) {
    msg.send("OK");
    event.ok(); // Отвечаем callback api серверу OK
});

// все остальное идет в callback type
// Например если участник вышел из сообщества
vk.on("group_leave",function (event, data) {
    if(data.self) // если сам вышел
        vk.messages.send({ // Отправляем сообщени
            message:"Ну куда же ты :_(", // текст сообщения
            peer_id: data.object.user_id // Кому
        });
    event.ok();
});
```
## Загрузка файлов по ссылке
```js
var VK = require("VK-Promise"),
    https = require("https"),
    vk = VK("Ваш access_token");

https.get("https://fs.flyink.ru/1.png",function(stream){
    stream.filename = "filename.png";
    vk.upload(
        "docs.getUploadServer",
        "docs.save",{
            files: {file: stream}
        }
    ).then(function (r) {
        console.log("response",r)
    }, console.error)
});
```
## Загрузка всей стены
```js
var vk = require("VK-Promise")("Ваш access_token"),
    readline = require('readline');

vk.getAll("wall.get",{owner_id: -2158488, count: 100},function (progress) {
    readline.clearLine(process.stdout, 0)
    readline.cursorTo(process.stdout, 0)
    process.stdout.write("Загружено: "+ progress.offset + " из " +progress.count);
}).then(function (res) {
    readline.clearLine(process.stdout, 0)
    readline.cursorTo(process.stdout, 0)
    console.log("Загружено записей:",res.length);
}, console.error);
```

## Дополнительные данные
- vk
    - retry: false - Отключение повтора запроса при 6й ошибке:  (true)
    - ignore_cart: true - Игнорирование очереди запросов (false)
    - ignore_execute_cart: true - Игнорирование сборщика запросов (false)
- vk.getAll
    - max_offset - максимальный offset


## Что нового
0.1.8
- Переписан build_execute_request (Надеюсь на этот раз все)

0.1.7
- Новый параметр disable_auto_deinit_cart

0.1.6
- Исправлен LongPoll
- Новое событие LongPollResponse
- msg.reply, msg.sendSticker

0.1.4
- Исправления в vk.build_execute_request
- Оптимизация в vk и vk.build_execute_request

0.1.3
- Из msg.get убран .items[0]
- Добавлены функции vk.getAll, vk.tryJSON
- Добавлены события LongPollError, LongPollRequest
- Исправлен VK.Array2Object
- Вернул VK.on("error", ... )
- Немного навел порядок в коде
- Немного переписал документацию

0.1.0
- VK.parseAttachments
- VK.cart, да, да, та самая
- добавлены опции VK(access_token, options)
- Исправлены ошибки vk.upload
- Кучу всего вынес из з msg.data[7] (action, from_id, emoji, emoji, sticker_id, attachments, итд...)
- vk.upload.groupCover
- vk.request
